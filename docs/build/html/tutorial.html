<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BatCat Tutorials &mdash; BatCat 0.2.9 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="BatCat API" href="api.html" />
    <link rel="prev" title="Installation Guide" href="install.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> BatCat
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="philosophy.html">Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">BatCat Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#data-science-projects-basics">Data Science Projects Basics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#environment-setup">Environment Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#logging">Logging</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#io-tools">IO Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#s3-bucket">S3 Bucket</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sql-redshift-athena">SQL: Redshift, Athena</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#deployment-on-cloud">Deployment on Cloud</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#background">Background</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup">Setup</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">BatCat API</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="contribute.html">Contribute to BatCat</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">BatCat</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>BatCat Tutorials</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tutorial.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="batcat-tutorials">
<h1>BatCat Tutorials<a class="headerlink" href="#batcat-tutorials" title="Permalink to this heading"></a></h1>
<div class="section" id="data-science-projects-basics">
<h2>Data Science Projects Basics<a class="headerlink" href="#data-science-projects-basics" title="Permalink to this heading"></a></h2>
<div class="section" id="environment-setup">
<h3>Environment Setup<a class="headerlink" href="#environment-setup" title="Permalink to this heading"></a></h3>
<p>The first step to start a data science project should always be setup a development file system, no matter on cloud or in your laptop. <strong>BatCat</strong> provides a one-line command to setup a well-organized file system for data science projects.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python -m batcat.FileSys
</pre></div>
</div>
<p>The interactive and immersive command-line interfaces as following. Just type down your project name, like <code class="code docutils literal notranslate"><span class="pre">battery</span></code> in this tutorial. Then it will generate a file structure for your data science project and print out a file tree of it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>hi, there! please write down your machine learning project&#39;s name.
project&#39;s name: battery
project_battery/
    requirements.txt
    README.md
    .gitignore
    docs/
        READM.md
    log/
    model/
    test/
    data/
        tmp/
        train/
        test/
        result/
        raw/
    notebook/
    report/
    script/
        config.json
    deploy/
        deploy.sh
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ol class="arabic simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">requirements.txt</span></code> includes all packages you need in your project. We recommend you to list not only package names but thier versions in the file. Besides, this serves your well if you develop your project on SageMaker, for you have to install all required packages every time restarting the Jupyter Notebook instance.</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">.gitignore</span></code> includes <code class="file docutils literal notranslate"><span class="pre">data/*</span></code> by default, which is our best practice in data science projects with <strong>git</strong>. Generally, you don’t want to git your data.</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">docs/READM.md</span></code> is inspired by <a class="reference external" href="https://docs.google.com/document/d/16R1E2ExKUCP5SlXWHr-KzbVDx9DBUclra-EbU8IB-iE/edit?usp=sharing">How to ML Paper - A brief Guide</a>. We highly recommend you to document your data science project in an organized way so that anyone, including youself, can catch up your thoughts in the future.</p></li>
</ol>
</div>
</div>
<div class="section" id="logging">
<h3>Logging<a class="headerlink" href="#logging" title="Permalink to this heading"></a></h3>
<p>Most data scientists spend little time on logging and may just print out along the experiement in Jupyter Notebook. However, this can make annoying troubles when it comes to production environment or when the data science experiements require a long period to generate experiement records. Therefore, logging is critical to a data science project.</p>
<p>Python Module <strong>Logging</strong> is one of the most underrated features. Two things (5&amp;3) to take away from <strong>Logging</strong>:</p>
<ol class="arabic simple">
<li><p><strong>5 levels</strong> of importance that logs can contain(debug, info, warning, error, critical);</p></li>
<li><p><strong>3 components</strong> to configure a logger in Python (a logger, a formatter, and at least one handler).</p></li>
</ol>
<p><strong>BatCat</strong> provides a function <code class="code docutils literal notranslate"><span class="pre">get_logger</span></code> to make life easier.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">batcat</span> <span class="k">as</span> <span class="nn">bc</span>

<span class="n">log_name</span> <span class="o">=</span> <span class="s1">&#39;battery&#39;</span>
<span class="n">log_file</span> <span class="o">=</span> <span class="s1">&#39;../log/batter.log&#39;</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="n">logName</span><span class="o">=</span><span class="n">log_name</span><span class="p">,</span> <span class="n">logFile</span><span class="o">=</span><span class="n">log_file</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;this is a debug&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;this is a test&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;this is a warning&#39;</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;this is an error!&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">critial</span><span class="p">(</span><span class="s1">&#39;this is critical!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="io-tools">
<h2>IO Tools<a class="headerlink" href="#io-tools" title="Permalink to this heading"></a></h2>
<p><strong>Services on AWS</strong>: S3, Redshift, Athena.</p>
<p><strong>BatCat</strong> supports reading data from S3 bucket (directly or by Athena or Redshift) and saving back to S3.</p>
<div class="section" id="s3-bucket">
<h3>S3 Bucket<a class="headerlink" href="#s3-bucket" title="Permalink to this heading"></a></h3>
<p>Read CSV data directly from S3 and save a DataFrame to S3.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">bucket</span> <span class="o">=</span> <span class="s1">&#39;2022-RnD-battery&#39;</span>
<span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;usage&#39;</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">read_csv_from_bucket</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

<span class="n">bc</span><span class="o">.</span><span class="n">save_to_bucket</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="sql-redshift-athena">
<h3>SQL: Redshift, Athena<a class="headerlink" href="#sql-redshift-athena" title="Permalink to this heading"></a></h3>
<p>The above approach is fine with a given S3 object but can be tricky when it comes to scenarios you need write SQLs to query data. This can be handled with Athena and Redshift.</p>
<ol class="arabic simple">
<li><p><strong>Athena</strong>: Service Glue is required before you query with Athena.</p></li>
<li><dl class="simple">
<dt><strong>Redshift</strong>:</dt><dd><ul class="simple">
<li><p>Option 1: With host/password.</p></li>
<li><p>Option 2: With Secret Manager.</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">query_athena</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT</span>
<span class="s2">    vin,</span>
<span class="s2">    usage,</span>
<span class="s2">    time</span>
<span class="s2">FROM</span>
<span class="s2">    cdc.dw_bms.battery_usage</span>
<span class="s2">WHERE</span>
<span class="s2">    time &gt;= &#39;</span><span class="si">{}</span><span class="s2">&#39; and time &lt;= &#39;</span><span class="si">{}</span><span class="s2">&#39;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">query_redshift</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT</span>
<span class="s2">    vin,</span>
<span class="s2">    usage,</span>
<span class="s2">    time</span>
<span class="s2">FROM</span>
<span class="s2">    cdc_dw_bms.battery_usage</span>
<span class="s2">WHERE</span>
<span class="s2">    time &gt;= &#39;</span><span class="si">{}</span><span class="s2">&#39; and time &lt;= &#39;</span><span class="si">{}</span><span class="s2">&#39;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">date_start</span> <span class="o">=</span> <span class="s1">&#39;2022-01-01&#39;</span>
<span class="n">date_end</span> <span class="o">=</span> <span class="s1">&#39;2022-08-01&#39;</span>

<span class="c1"># from Athena</span>
<span class="n">region</span> <span class="o">=</span> <span class="s1">&#39;cn-northwest-1&#39;</span>
<span class="n">s3_staging_dir</span> <span class="o">=</span> <span class="s2">&quot;s3://apac-athena-queryresult/ATHENA_QUERY&quot;</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">read_data_from_athena</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                              <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                              <span class="n">s3_staging_dir</span><span class="o">=</span><span class="n">s3_staging_dir</span><span class="p">,</span>
                              <span class="n">date_start</span><span class="o">=</span><span class="n">date_start</span><span class="p">,</span>
                              <span class="n">date_end</span><span class="o">=</span><span class="n">date_end</span><span class="p">)</span>

<span class="c1"># from RedShift</span>
<span class="c1"># with host/password</span>
<span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;0.1.1.1&#39;</span>
<span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;this_is_a_password&#39;</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">read_data_from_redshift</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                                <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                                <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
                                <span class="n">port</span><span class="o">=</span><span class="mi">5439</span><span class="p">,</span>
                                <span class="n">database</span><span class="o">=</span><span class="s1">&#39;dev&#39;</span><span class="p">,</span>
                                <span class="n">user</span><span class="o">=</span><span class="s1">&#39;awsuser&#39;</span><span class="p">,</span>
                                <span class="n">date_start</span><span class="o">=</span><span class="n">date_start</span><span class="p">,</span>
                                <span class="n">date_end</span><span class="o">=</span><span class="n">date_end</span><span class="p">)</span>

<span class="c1"># with secret manager</span>
<span class="n">secret_name</span> <span class="o">=</span> <span class="s1">&#39;secret/manager&#39;</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">read_data_from_redshift_by_secret</span><span class="p">(</span><span class="n">secret_name</span><span class="o">=</span><span class="n">secret_name</span><span class="p">,</span>
                                          <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                                          <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ol class="arabic simple">
<li><p><strong>Athena</strong> is recommended as Redshift approach may raise timeout error OR be blocked by VPC if the Redshift is located in it.</p></li>
<li><dl class="simple">
<dt>Pay attention to the queries for Athena and RedShift are different.</dt><dd><ul class="simple">
<li><p><strong>Athena</strong>: <code class="code docutils literal notranslate"><span class="pre">[datasource].[database]</span></code></p></li>
<li><p><strong>RedShift</strong>: <code class="code docutils literal notranslate"><span class="pre">[datasource]_[database]</span></code> as schema.</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="deployment-on-cloud">
<h2>Deployment on Cloud<a class="headerlink" href="#deployment-on-cloud" title="Permalink to this heading"></a></h2>
<p><strong>Services on AWS</strong>: ECR, SageMaker Processing, Step Functions, and Lambda.</p>
<div class="section" id="background">
<h3>Background<a class="headerlink" href="#background" title="Permalink to this heading"></a></h3>
<p>Before we dive in the topic, let’s align on the meaning of “deployment on cloud”. This basicly involves <strong>microservice</strong> like container and <strong>serverless</strong>. In the AWS context, it related services:</p>
<ul class="simple">
<li><p>ECR</p></li>
<li><p>SageMaker Processing</p></li>
<li><p>Step Functions</p></li>
<li><p>Lambda</p></li>
<li><p>IAM</p></li>
</ul>
<p>Amazon SageMaker lets developers and data scientists train and deploy machine learning models. With Amazon SageMaker Processing, you can run processing jobs for data processing steps in your machine learning pipeline.</p>
<p>However, the most annoying part of SageMaker is that it offers many modules <em>to faciliate</em> model development and deployment but looks like a white elephant. What a data scientist need is something with shallow learning curve and the knowledge can be transfered to other cloud services, <strong>NOT</strong> something only works on AWS, which betrays the intend to use Docker!</p>
<p>So here’s BatCat. It provides templates to setup docker images, workflows of Step Functions, and triggers generated by Lambda functions – to slim down the setup work on AWS.</p>
<img alt="_images/process.svg" class="align-center" src="_images/process.svg" /><p><strong>BatCat</strong> takes all steps in a machine learning product as processing jobs – data cleaning, preprocessing, feature engineering, predicting. Note that the training step is not in production stage but development stage so not inlcuded here.</p>
</div>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this heading"></a></h3>
<ol class="arabic simple">
<li><dl class="simple">
<dt>Create related roles and attach policies to it.</dt><dd><p>Like any other AWS services, roles and policies setup is one of the most disappointing parts when using it. Refer to <a class="reference internal" href="appendix.html#identity-and-access-management-iam"><span class="std std-ref">Identity and Access Management</span></a> for more information.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Setup templates:</dt><dd><ol class="arabic simple">
<li><p>Docker setup Bash script and requirements text file. Add more required Python packages to <code class="file docutils literal notranslate"><span class="pre">requirements.txt</span></code> as needed.</p></li>
<li><p>Step Functions setup Python script.</p></li>
<li><p>Lambda function setup Python script.</p></li>
</ol>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Add the data science core script.</dt><dd><p>Add your data science Python script to the current directory, whose name should aligned with <code class="code docutils literal notranslate"><span class="pre">purpose</span></code>. In the example below, it is <code class="code docutils literal notranslate"><span class="pre">usage-analysis.py</span></code>.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Run the scripts to deploy.</dt><dd><p>That’s it!</p>
</dd>
</dl>
</li>
</ol>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">project</span> <span class="o">=</span> <span class="s1">&#39;2022-RnD-battery&#39;</span>
<span class="n">purpose</span> <span class="o">=</span> <span class="s1">&#39;usage-analysis&#39;</span>

<span class="n">result_s3_bucket</span> <span class="o">=</span> <span class="s1">&#39;2022-RnD-battery&#39;</span>

<span class="n">workflow_execution_role</span> <span class="o">=</span> <span class="s1">&#39;arn:aws-cn:iam::[account-id]:role/[role-name]&#39;</span>

<span class="c1"># setup Docker environment</span>
<span class="n">bc</span><span class="o">.</span><span class="n">template_docker</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
                   <span class="n">uri_suffix</span><span class="o">=</span><span class="s1">&#39;amazonaws.com.cn&#39;</span><span class="p">,</span>
                   <span class="n">pip_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">python_version</span><span class="o">=</span><span class="s1">&#39;3.7-slim-buster&#39;</span><span class="p">)</span>

<span class="c1"># setup Step Functions workflow</span>
<span class="n">bc</span><span class="o">.</span><span class="n">template_stepfunctions</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
                          <span class="n">purpose</span><span class="o">=</span><span class="n">purpose</span><span class="p">,</span>
                          <span class="n">result_s3_bucket</span><span class="o">=</span><span class="n">s3</span><span class="o">-</span><span class="n">bucket</span><span class="p">,</span>
                          <span class="n">workflow_execution_role</span><span class="o">=</span><span class="n">workflow_execution_role</span><span class="p">)</span>

<span class="c1"># setup lambda to trigger workflow</span>
<span class="n">bc</span><span class="o">.</span><span class="n">template_lambda</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
                   <span class="n">purpose</span><span class="o">=</span><span class="n">purpose</span><span class="p">,</span>
                   <span class="n">result_s3_bucket</span><span class="o">=</span><span class="n">s3</span><span class="o">-</span><span class="n">bucket</span><span class="p">,</span>
                   <span class="n">partition</span><span class="o">=</span><span class="s1">&#39;aws-cn&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ol class="arabic simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">project</span></code>: your data science project name. We suggest a format as <code class="code docutils literal notranslate"><span class="pre">[year]-[department]-[topic]</span></code>.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">purpose</span></code>: or subproject under a project.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">result_s3_bucket</span></code>: the S3 bucket to store data science results.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">workflow_execution_role</span></code>: the role ARN you created in step 1.</p></li>
</ol>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="install.html" class="btn btn-neutral float-left" title="Installation Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="api.html" class="btn btn-neutral float-right" title="BatCat API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Ewen Wang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>